{% extends "base.html" %}
{% load lang %}

{% block title %}
Juz {{ juz.number }} | Islamic Web
{% endblock %}

{% block content %}
<h2>Juz {{ juz.number }}</h2>

{# ---------------- Play All Button ---------------- #}
<div class="play-all-container" style="margin-bottom:20px;">
  <button class="play-all-btn" type="button" data-play-all data-queue-script="queue_juz"
          style="padding:10px 16px; border-radius:12px; font-weight:700; background:#1f2933; color:#fff; border:none; cursor:pointer;">
    ▶ Play All
  </button>
</div>

{# ---------------- JSON Queue (skip items without audio) ---------------- #}
<script id="queue_juz" type="application/json">
[
{% for r in recitations %}
  {% if r.audio_file %}
  {
    "audio": "{{ r.audio_file.url }}",
    "title": "{{ r.surah.number }} - {% t request r.surah 'name' %} — {% t request r.reciter 'name' %} ({{ r.recitation_type }})"
  }{% if not forloop.last %},{% endif %}
  {% endif %}
{% endfor %}
]
</script>

<h3>Recitations</h3>

<div class="cards">
  {% for r in recitations %}
    <div class="card">

      {% if r.surah.image %}
        <div class="card-media">
          <img src="{{ r.surah.image.url }}" alt="{% t request r.surah 'name' %}">
          <div class="play-overlay">
            {% if r.audio_file %}
              <a class="play-btn"
                 href="#"
                 data-play-one
                 data-recitation-id="{{ r.id }}"
                 data-audio="{{ r.audio_file.url }}"
                 data-title="{{ r.surah.number }} - {% t request r.surah 'name' %} — {% t request r.reciter 'name' %} ({{ r.recitation_type }})">
                ▶ Play
              </a>
            {% endif %}
          </div>
        </div>
      {% endif %}

      <p class="card-title">
        {{ r.surah.number }} - {% t request r.surah "name" %}
      </p>

      <p class="card-sub">
        {% t request r.reciter "name" %} ({{ r.recitation_type }})
      </p>

      <div class="card-actions" style="display:flex;gap:6px;flex-wrap:wrap;">

        {% if r.audio_file %}
        <a class="play-btn-inline"
           href="#"
           data-play-one
           data-recitation-id="{{ r.id }}"
           data-audio="{{ r.audio_file.url }}"
           data-title="{{ r.surah.number }} - {% t request r.surah 'name' %} — {% t request r.reciter 'name' %} ({{ r.recitation_type }})"
           style="padding:6px 12px; border-radius:8px; background:#1f2933; color:#fff; text-decoration:none;">
          ▶ Play
        </a>
        {% else %}
        <span style="padding:6px 12px;border-radius:8px;background:#e5e7eb;color:#374151;">
          No audio
        </span>
        {% endif %}

        <a href="{% url 'surah_detail' r.surah.id %}"
           style="padding:6px 12px; border-radius:8px; background:#3b82f6; color:#fff; text-decoration:none;">
          Surah
        </a>

        {% if request.user.is_authenticated %}
        <form method="post" action="{% url 'add_to_favorites' %}" style="display:inline;">
          {% csrf_token %}
          <input type="hidden" name="recitation_id" value="{{ r.id }}">
          <button type="submit" style="padding:6px 12px; border-radius:8px; border:none; background:#f59e0b; color:#fff; cursor:pointer;">
            ❤️ Favorite
          </button>
        </form>

        <form method="post" action="{% url 'add_to_playlist' %}" style="display:inline; flex-wrap:wrap;">
          {% csrf_token %}
          <input type="hidden" name="recitation_id" value="{{ r.id }}">
          <select name="playlist_id" required style="padding:6px 8px; border-radius:8px; border:1px solid #ccc;">
            <option value="">Select Playlist</option>
            {% for p in request.user.playlists.all %}
              <option value="{{ p.id }}">{{ p.name }}</option>
            {% endfor %}
          </select>
          <button type="submit" style="padding:6px 12px; border-radius:8px; border:none; background:#10b981; color:#fff; cursor:pointer;">
            ➕ Add
          </button>
        </form>
        {% endif %}

      </div>
    </div>
  {% empty %}
    <p>No recitations available for this Juz.</p>
  {% endfor %}
</div>

{% endblock %}
