{% extends "base.html" %}
{% load static %}
{% load lang %}

{% block title %}Recitations | Islamic Web{% endblock %}

{% block content %}
<div class="container">
  <!-- Page Header -->
  <div class="page-header">
    <h1 class="page-title">Recitations</h1>
    <p class="page-subtitle">Browse and filter Quran recitations</p>
  </div>

  <!-- Filter Card -->
  <div class="filter-card">
    <div class="filter-card-header">
      <h3 class="filter-card-title">Filter Recitations</h3>
      {% if selected_surah or selected_reciter or selected_juz %}
        <a href="{% url 'recitation_list' %}" class="filter-reset">Reset Filters</a>
      {% endif %}
    </div>

    <form method="get" class="filter-form">
      <div class="filter-grid">
        <!-- Surah Filter -->
        <div class="filter-group">
          <label class="filter-label" for="surah">Surah</label>
          <select class="filter-select" id="surah" name="surah">
            <option value="">All Surahs</option>
            {% for s in surahs %}
              <option value="{{ s.id }}" {% if selected_surah == s.id|stringformat:"s" %}selected{% endif %}>
                {{ s.number }} - {% t request s "name" %}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- Reciter Filter -->
        <div class="filter-group">
          <label class="filter-label" for="reciter">Reciter</label>
          <select class="filter-select" id="reciter" name="reciter">
            <option value="">All Reciters</option>
            {% for r in reciters %}
              <option value="{{ r.id }}" {% if selected_reciter == r.id|stringformat:"s" %}selected{% endif %}>
                {% t request r "name" %}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- Juz Filter -->
        <div class="filter-group">
          <label class="filter-label" for="juz">Juz</label>
          <select class="filter-select" id="juz" name="juz">
            <option value="">All Juz</option>
            {% for j in juzs %}
              <option value="{{ j.id }}" {% if selected_juz == j.id|stringformat:"s" %}selected{% endif %}>
                Juz {{ j.number }}
              </option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="filter-actions">
        <button type="submit" class="btn btn-primary">Apply Filters</button>
      </div>
    </form>
  </div>

  <!-- Results Section -->
  <div class="section">
    <div class="section-head">
      <h3 class="mb-0">Recitations</h3>

      <div class="section-head-right">
        <div class="results-count">
          {% if recitations %}
            {{ recitations|length }} recitation{{ recitations|length|pluralize }}
            {% if selected_surah or selected_reciter or selected_juz %}(filtered){% endif %}
          {% endif %}
        </div>

        {% if recitations %}
          <div class="play-all-container">
            <button class="btn btn-primary btn-sm" type="button" data-play-all data-queue-script="queue_all">
              Play All
            </button>
          </div>
        {% endif %}
      </div>
    </div>

    {# ‚úÖ Play All Queue JSON (ALWAYS valid JSON ‚Äî no comma problems) #}
    {% if recitations %}
      <script id="queue_all" type="application/json">
      [
      {% for rec in recitations %}
        {
          "id": "{{ rec.id }}",
          "audio": "{% if rec.audio_file %}{{ rec.audio_file.url }}{% else %}{% endif %}",
          "title": "{{ rec.surah.number }} - {% t request rec.surah 'name' %} ‚Äî {% t request rec.reciter 'name' %} ({{ rec.recitation_type }})"
        }{% if not forloop.last %},{% endif %}
      {% endfor %}
      ]
      </script>
    {% endif %}

    {% if recitations %}
      <!-- Recitations Grid -->
      <div class="cards">
        {% for rec in recitations %}
          <div class="card recitation-card">

            {# ‚úÖ Image FIX: use image.url directly #}
            {% if rec.surah.image and rec.surah.image.name %}
              <div class="card-media">
                <img src="{{ rec.surah.image.url }}" alt="{% t request rec.surah 'name' %}">
                <div class="play-overlay">
                  {% if rec.audio_file %}
                    <button
                      type="button"
                      class="btn btn-primary play-btn"
                      data-play-one
                      data-recitation-id="{{ rec.id }}"
                      data-audio="{{ rec.audio_file.url }}"
                      data-title="{{ rec.surah.number }} - {% t request rec.surah 'name' %} ‚Äî {% t request rec.reciter 'name' %} ({{ rec.recitation_type }})"
                      aria-label="Play recitation">
                      ‚ñ∂
                    </button>
                  {% endif %}
                </div>
              </div>
            {% endif %}

            <div class="card-body">
              <div class="card-header">
                <h3 class="card-title">
                  {{ rec.surah.number }} - {% t request rec.surah "name" %}
                </h3>

                <p class="card-subtitle">
                  <span aria-hidden="true">üë§</span> {% t request rec.reciter "name" %}
                </p>

                <div class="card-meta">
                  <span class="badge badge-type">{{ rec.recitation_type|title }}</span>

                  {% if rec.surah.juz.all %}
                    <span class="badge badge-juz">
                      {% for juz in rec.surah.juz.all %}
                        Juz {{ juz.number }}{% if not forloop.last %}, {% endif %}
                      {% endfor %}
                    </span>
                  {% endif %}
                </div>
              </div>

              <div class="card-actions">
                {% if rec.audio_file %}
                  <button
                    type="button"
                    class="btn btn-primary"
                    data-play-one
                    data-recitation-id="{{ rec.id }}"
                    data-audio="{{ rec.audio_file.url }}"
                    data-title="{{ rec.surah.number }} - {% t request rec.surah 'name' %} ‚Äî {% t request rec.reciter 'name' %} ({{ rec.recitation_type }})">
                    Play
                  </button>
                {% else %}
                  <span class="btn btn-neutral btn-sm" style="pointer-events:none;opacity:.8;">No Audio</span>
                {% endif %}

                <a href="{% url 'surah_detail' rec.surah.id %}" class="btn btn-secondary">Surah</a>

                {% if user.is_authenticated %}
                  <!-- Add to Favorites -->
                  <form method="post" action="{% url 'add_to_favorites' %}" class="favorite-form">
                    {% csrf_token %}
                    <input type="hidden" name="recitation_id" value="{{ rec.id }}">
                    <button type="submit" class="btn btn-outline btn-favorite" title="Add to Favorites" aria-label="Add to favorites">
                      ‚ô°
                    </button>
                  </form>

                  <!-- Add to Playlist -->
                  <form method="post" action="{% url 'add_to_playlist' %}" class="inline-form">
                    {% csrf_token %}
                    <input type="hidden" name="recitation_id" value="{{ rec.id }}">

                    <label class="sr-only" for="pl_{{ rec.id }}">Playlist</label>
                    <select id="pl_{{ rec.id }}" name="playlist_id" required class="select-sm">
                      <option value="">Playlist</option>
                      {% for p in request.user.playlists.all %}
                        <option value="{{ p.id }}">{{ p.name }}</option>
                      {% endfor %}
                    </select>

                    <button type="submit" class="btn btn-success btn-sm" title="Add to playlist" aria-label="Add to playlist">
                      +
                    </button>
                  </form>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- Pagination -->
      {% if recitations.has_other_pages %}
        <div class="pagination">
          {% if recitations.has_previous %}
            <a href="?page={{ recitations.previous_page_number }}{% if selected_surah %}&surah={{ selected_surah }}{% endif %}{% if selected_reciter %}&reciter={{ selected_reciter }}{% endif %}{% if selected_juz %}&juz={{ selected_juz }}{% endif %}"
               class="btn btn-outline btn-sm">
              ‚Üê Previous
            </a>
          {% endif %}

          <span class="page-info">
            Page {{ recitations.number }} of {{ recitations.paginator.num_pages }}
          </span>

          {% if recitations.has_next %}
            <a href="?page={{ recitations.next_page_number }}{% if selected_surah %}&surah={{ selected_surah }}{% endif %}{% if selected_reciter %}&reciter={{ selected_reciter }}{% endif %}{% if selected_juz %}&juz={{ selected_juz }}{% endif %}"
               class="btn btn-outline btn-sm">
              Next ‚Üí
            </a>
          {% endif %}
        </div>
      {% endif %}

    {% else %}
      <!-- No Results -->
      <div class="no-results">
        <div class="no-results-icon" aria-hidden="true">üîé</div>
        <h3>No recitations found</h3>
        <p>Try adjusting your filters or browse all recitations</p>
        <a href="{% url 'recitation_list' %}" class="btn btn-primary">View All Recitations</a>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const activeFilters = [];

  const surahSelect = document.getElementById('surah');
  const reciterSelect = document.getElementById('reciter');
  const juzSelect = document.getElementById('juz');

  if (surahSelect && surahSelect.value) {
    activeFilters.push('Surah: ' + surahSelect.options[surahSelect.selectedIndex].text);
  }
  if (reciterSelect && reciterSelect.value) {
    activeFilters.push('Reciter: ' + reciterSelect.options[reciterSelect.selectedIndex].text);
  }
  if (juzSelect && juzSelect.value) {
    activeFilters.push('Juz: ' + juzSelect.options[juzSelect.selectedIndex].text);
  }

  if (activeFilters.length > 0) {
    const right = document.querySelector('.section-head-right');
    if (right) {
      const badge = document.createElement('span');
      badge.className = 'badge badge-juz';
      badge.textContent = activeFilters.length + ' filter' + (activeFilters.length > 1 ? 's' : '');
      badge.title = activeFilters.join('\n');
      badge.style.cursor = 'help';
      right.appendChild(badge);
    }
  }
});
</script>
{% endblock %}
