{% extends "base.html" %}
{% load lang %}

{% block title %}
{% t request reciter "name" %} | Islamic Web
{% endblock %}

{% block content %}
<div class="reciter-header">
  {% if reciter.image %}
    <div class="reciter-image">
      <img src="{{ reciter.image.url }}" alt="{% t request reciter 'name' %}">
    </div>
  {% endif %}

  <div class="reciter-info">
    <h2>{% t request reciter "name" %}</h2>
    <p>
      Total Recitations: {{ recitations|length }}<br>
      Country: {% if reciter.country_en %}{% t request reciter "country" %}{% else %}Unknown{% endif %}
    </p>

    <!-- ▶ Play All ONLY -->
    <div class="play-all-container">
      <button class="play-all-btn"
              type="button"
              data-play-all
              data-queue-script="queue_reciter">
        ▶ Play All
      </button>
    </div>
  </div>
</div>

<!-- ✅ Queue data for Play All (ONLY items with audio_file, includes id for history) -->
<script id="queue_reciter" type="application/json">
[
{% for r in recitations %}
  {% if r.audio_file %}
  {
    "id": "{{ r.id }}",
    "audio": "{{ r.audio_file.url }}",
    "title": "{{ r.surah.number }} - {% t request r.surah 'name' %} — {% t request r.reciter 'name' %} ({{ r.recitation_type }})"
  }{% if not forloop.last %},{% endif %}
  {% endif %}
{% endfor %}
]
</script>

<div class="cards">
  {% for r in recitations %}
    <div class="card recitation-card">

      {% if r.surah.image %}
        <div class="card-media">
          <img src="{{ r.surah.image.url }}" alt="{% t request r.surah 'name' %}">

          {% if r.audio_file %}
          <div class="play-overlay">
            <a class="play-btn"
               href="#"
               data-play-one
               data-recitation-id="{{ r.id }}"
               data-audio="{{ r.audio_file.url }}"
               data-title="{{ r.surah.number }} - {% t request r.surah 'name' %} — {% t request r.reciter 'name' %} ({{ r.recitation_type }})">
              ▶ Play
            </a>
          </div>
          {% endif %}

        </div>
      {% endif %}

      <p class="card-title">
        {{ r.surah.number }} - {% t request r.surah "name" %}
      </p>

      <p class="card-sub">
        {% t request r.reciter "name" %} ({{ r.recitation_type }})
      </p>

      <div class="card-actions" style="display:flex;gap:6px;flex-wrap:wrap;">

        {% if r.audio_file %}
        <a href="#"
           data-play-one
           data-recitation-id="{{ r.id }}"
           data-audio="{{ r.audio_file.url }}"
           data-title="{{ r.surah.number }} - {% t request r.surah 'name' %} — {% t request r.reciter 'name' %} ({{ r.recitation_type }})"
           style="padding:6px 12px;border-radius:8px;background:#4CAF50;color:#fff;text-decoration:none;">
          ▶ Play
        </a>
        {% else %}
        <span style="padding:6px 12px;border-radius:8px;background:#e5e7eb;color:#374151;">
          No Audio
        </span>
        {% endif %}

        <a href="{% url 'surah_detail' r.surah.id %}"
           style="padding:6px 12px;border-radius:8px;border:1px solid #ccc;text-decoration:none;">
          Surah
        </a>

        {% if request.user.is_authenticated %}
        <form method="post" action="{% url 'add_to_favorites' %}" style="display:inline;">
          {% csrf_token %}
          <input type="hidden" name="recitation_id" value="{{ r.id }}">
          <button type="submit"
                  style="padding:6px 12px;border-radius:8px;border:none;background:#f59e0b;color:#fff;cursor:pointer;">
            ❤️ Favorite
          </button>
        </form>

        <form method="post" action="{% url 'add_to_playlist' %}" style="display:inline-flex;gap:6px;">
          {% csrf_token %}
          <input type="hidden" name="recitation_id" value="{{ r.id }}">

          <select name="playlist_id" required style="padding:6px 8px;border-radius:8px;">
            <option value="">Playlist</option>
            {% for p in request.user.playlists.all %}
              <option value="{{ p.id }}">{{ p.name }}</option>
            {% endfor %}
          </select>

          <button type="submit"
                  style="padding:6px 12px;border-radius:8px;border:none;background:#10b981;color:#fff;cursor:pointer;">
            ➕ Add
          </button>
        </form>
        {% endif %}

      </div>
    </div>
  {% empty %}
    <p>No recitations for this reciter yet.</p>
  {% endfor %}
</div>
{% endblock %}

{% block extra_js %}
{# No custom JS needed – global player handles play-all & play-one #}
{% endblock %}
