{% extends "base.html" %}
{% load lang %}

{% block title %}Search | Islamic Web{% endblock %}

{% block content %}
<h2>Search</h2>

<form method="get" class="auth-form" style="max-width:700px;">
  <p>
    <label for="q">Search</label><br>
    <input id="q" type="text" name="q" value="{{ q }}" placeholder="Search surah / reciter..." />
  </p>
  <button type="submit">Search</button>
</form>

{% if q %}

<!-- ================= SURAHS ================= -->
<h3>Surahs</h3>
<div class="cards">
  {% for s in surahs %}
    <div class="card">

      {% if s.image %}
        <div class="card-media">
          <img src="{{ s.image.url }}" alt="{% t request s 'name' %}">
        </div>
      {% endif %}

      <p class="card-title">
        {{ s.number }} - {% t request s "name" %}
      </p>

      <div class="card-actions">
        <a class="btn btn-secondary" href="{% url 'surah_detail' s.id %}">Open</a>
      </div>

    </div>
  {% empty %}
    <p>No surahs found.</p>
  {% endfor %}
</div>

<!-- ================= RECITERS ================= -->
<h3>Reciters</h3>
<div class="cards">
  {% for r in reciters %}
    <div class="card">

      {% if r.image %}
        <div class="card-media">
          <img src="{{ r.image.url }}" alt="{% t request r 'name' %}">
        </div>
      {% endif %}

      <p class="card-title">
        {% t request r "name" %}
      </p>

      <div class="card-actions">
        <a class="btn btn-secondary" href="{% url 'reciter_detail' r.id %}">Open</a>
      </div>

    </div>
  {% empty %}
    <p>No reciters found.</p>
  {% endfor %}
</div>

<!-- ================= RECITATIONS ================= -->
<h3>Recitations</h3>

{% if recitations %}
  <!-- ▶ PLAY ALL -->
  <button class="btn btn-primary btn-sm" type="button" data-play-all data-queue-script="queue_search"
          style="margin-bottom:12px;">
    ▶ Play All
  </button>

  <!-- Queue (skip missing audio) -->
  <script id="queue_search" type="application/json">
  [
  {% for r in recitations %}
    {% if r.audio_file %}
    {
      "audio": "{{ r.audio_file.url }}",
      "title": "{{ r.surah.number }} - {% t request r.surah 'name' %} — {% t request r.reciter 'name' %} ({{ r.recitation_type }})"
    }{% if not forloop.last %},{% endif %}
    {% endif %}
  {% endfor %}
  ]
  </script>
{% endif %}

<div class="cards">
  {% for rec in recitations %}
    <div class="card">

      {% if rec.surah.image %}
        <div class="card-media">
          <img src="{{ rec.surah.image.url }}" alt="{% t request rec.surah 'name' %}">
        </div>
      {% endif %}

      <p class="card-title">
        {{ rec.surah.number }} - {% t request rec.surah "name" %}
      </p>

      <p class="card-sub">
        {% t request rec.reciter "name" %} ({{ rec.recitation_type }})
      </p>

      <div class="card-actions" style="display:flex;gap:8px;flex-wrap:wrap;">

        {% if rec.audio_file %}
          <a class="btn btn-primary btn-sm"
             href="#"
             data-play-one
             data-audio="{{ rec.audio_file.url }}"
             data-title="{{ rec.surah.number }} - {% t request rec.surah 'name' %} — {% t request rec.reciter 'name' %} ({{ rec.recitation_type }})">
            ▶ Play
          </a>
        {% else %}
          <span class="btn btn-neutral btn-sm" style="pointer-events:none;opacity:.8;">No Audio</span>
        {% endif %}

        <a class="btn btn-secondary btn-sm" href="{% url 'surah_detail' rec.surah.id %}">Surah</a>
        <a class="btn btn-secondary btn-sm" href="{% url 'reciter_detail' rec.reciter.id %}">Reciter</a>

        {% if request.user.is_authenticated %}
          <form method="post" action="{% url 'add_to_favorites' %}" style="display:inline;">
            {% csrf_token %}
            <input type="hidden" name="recitation_id" value="{{ rec.id }}">
            <button class="btn btn-warning btn-sm" type="submit" title="Add to favorites">❤️</button>
          </form>

          <form method="post" action="{% url 'add_to_playlist' %}" class="inline-form" style="display:inline-flex;gap:6px;align-items:center;">
            {% csrf_token %}
            <input type="hidden" name="recitation_id" value="{{ rec.id }}">
            <select name="playlist_id" required class="select-sm">
              <option value="">Playlist</option>
              {% for p in request.user.playlists.all %}
                <option value="{{ p.id }}">{{ p.name }}</option>
              {% endfor %}
            </select>
            <button class="btn btn-success btn-sm" type="submit" title="Add to playlist">➕</button>
          </form>
        {% endif %}

      </div>
    </div>
  {% empty %}
    <p>No recitations found.</p>
  {% endfor %}
</div>

{% endif %}
{% endblock %}
