{% load static %}
<!DOCTYPE html>
<html lang="en"
  dir="{% if request.session.rtl %}rtl{% else %}ltr{% endif %}"
  data-theme="{% if request.session.dark %}dark{% else %}light{% endif %}">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}Islamic Web{% endblock %}</title>

  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  {% block extra_css %}{% endblock %}
</head>

<body>
<header class="site-header">
  <div class="container header-container">

    <button class="icon-btn mobile-menu-toggle" type="button" id="mobileMenuToggle" aria-label="Open menu">â˜°</button>

    <a class="brand" href="{% url 'home' %}">
      <span class="brand-logo" aria-hidden="true">ğŸ•Œ</span>
      <span class="brand-title">Islamic Web</span>
    </a>

    <nav class="navbar" aria-label="Main navigation">
      <div class="nav-left">
        <a class="nav-link" href="{% url 'home' %}">Home</a>
        <a class="nav-link" href="{% url 'juz_list' %}">Juz</a>
        <a class="nav-link" href="{% url 'reciter_list' %}">Reciters</a>
        <a class="nav-link" href="{% url 'recitation_list' %}">Recitations</a>
        <a class="nav-link" href="{% url 'favorites' %}">Favorites</a>
        <a class="nav-link" href="{% url 'playlists' %}">Playlists</a>
      </div>

      <form method="get" action="{% url 'search' %}" class="nav-search" role="search">
        <input class="input" type="text" name="q" placeholder="Search..." aria-label="Search">
        <button class="icon-btn" type="submit" aria-label="Search">ğŸ”</button>
      </form>

      <div class="nav-right">
        <a class="pill" href="{% url 'toggle_rtl' %}" title="Toggle language direction">
          {% if request.session.rtl %}EN{% else %}AR{% endif %}
        </a>

        <a class="pill" href="{% url 'toggle_dark' %}" title="Toggle theme">
          {% if request.session.dark %}â˜€ï¸{% else %}ğŸŒ™{% endif %}
        </a>

        <!-- ACCOUNT DROPDOWN -->
        <div class="nav-account" data-dd>
          <button type="button"
                  class="account-btn"
                  data-dd-btn
                  aria-haspopup="menu"
                  aria-expanded="false">
            {% if user.is_authenticated %}
              {{ user.username|truncatechars:12 }}
            {% else %}
              Account
            {% endif %}
            <span class="caret" aria-hidden="true">â–¾</span>
          </button>

          <div class="dropdown" data-dd-menu role="menu">
            {% if user.is_authenticated %}
              <a class="dd-link" href="{% url 'favorites' %}" role="menuitem">â¤ï¸ Favorites</a>
              <a class="dd-link" href="{% url 'history' %}" role="menuitem">ğŸ“œ History</a>
              <a class="dd-link" href="{% url 'playlists' %}" role="menuitem">ğŸµ Playlists</a>

              <div class="dd-sep" aria-hidden="true"></div>

              {% if user.is_staff %}
                <a class="dd-link" href="{% url 'staff_recitations' %}" role="menuitem">âš™ï¸ Manage Recitations</a>
                <div class="dd-sep" aria-hidden="true"></div>
              {% endif %}

              <form method="post" action="{% url 'logout' %}" class="dd-form">
                {% csrf_token %}
                <button type="submit" class="dd-link dd-btn" role="menuitem">ğŸšª Logout</button>
              </form>
            {% else %}
              <a class="dd-link" href="{% url 'login' %}" role="menuitem">ğŸ”‘ Login</a>
              <a class="dd-link" href="{% url 'register' %}" role="menuitem">ğŸ“ Register</a>
            {% endif %}
          </div>
        </div>
      </div>
    </nav>
  </div>
</header>

<!-- Mobile menu -->
<div class="mobile-menu" id="mobileMenu" aria-hidden="true">
  <div class="mobile-menu-panel">
    <div class="mobile-menu-header">
      <h3 class="mobile-menu-title">Menu</h3>
      <button class="icon-btn mobile-menu-close" type="button" id="mobileMenuClose" aria-label="Close menu">âœ•</button>
    </div>

    <div class="mobile-menu-content">
      <a class="mobile-nav-link" href="{% url 'home' %}">ğŸ  Home</a>
      <a class="mobile-nav-link" href="{% url 'juz_list' %}">ğŸ“– Juz</a>
      <a class="mobile-nav-link" href="{% url 'reciter_list' %}">ğŸ¤ Reciters</a>
      <a class="mobile-nav-link" href="{% url 'recitation_list' %}">ğŸµ Recitations</a>
      <a class="mobile-nav-link" href="{% url 'favorites' %}">â¤ï¸ Favorites</a>
      <a class="mobile-nav-link" href="{% url 'history' %}">ğŸ“œ History</a>
      <a class="mobile-nav-link" href="{% url 'playlists' %}">ğŸµ Playlists</a>

      <div class="mobile-actions">
        <a class="pill" href="{% url 'toggle_rtl' %}">{% if request.session.rtl %}EN{% else %}AR{% endif %}</a>
        <a class="pill" href="{% url 'toggle_dark' %}">{% if request.session.dark %}â˜€ï¸ Light{% else %}ğŸŒ™ Dark{% endif %}</a>
      </div>

      <div class="mobile-auth">
        {% if user.is_authenticated %}
          <form method="post" action="{% url 'logout' %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger btn-block">ğŸšª Logout</button>
          </form>
        {% else %}
          <a href="{% url 'login' %}" class="btn btn-primary btn-block">ğŸ”‘ Login</a>
          <a href="{% url 'register' %}" class="btn btn-secondary btn-block">ğŸ“ Register</a>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<hr class="soft-hr">

<main class="container page">
  {% block content %}{% endblock %}
</main>

<hr class="soft-hr">

<!-- MINI PLAYER -->
<div id="miniPlayer" class="mini-player" style="display:none;">
  <div class="mini-left">
    <div id="miniTitle" class="mini-title">â€”</div>
  </div>

  <div class="mini-controls">
    <button type="button" id="btnShuffle" data-tip="Shuffle" class="btn btn-neutral btn-sm">ğŸ”€</button>
    <button type="button" id="btnPrev" data-tip="Previous" class="btn btn-neutral btn-sm">â®</button>
    <button type="button" id="btnPlayPause" data-tip="Play / Pause" class="btn btn-primary btn-sm">â–¶</button>
    <button type="button" id="btnNext" data-tip="Next" class="btn btn-neutral btn-sm">â­</button>
    <button type="button" id="btnRepeat" data-tip="Repeat" class="btn btn-neutral btn-sm">ğŸ”</button>

    <select id="speedSelect" data-tip="Playback Speed" class="select-sm">
      <option value="0.75">0.75x</option>
      <option value="1" selected>1x</option>
      <option value="1.25">1.25x</option>
      <option value="1.5">1.5x</option>
      <option value="2">2x</option>
    </select>
  </div>

  <button id="btnMinimize" class="mini-minimize btn btn-neutral btn-sm" title="Minimize">â€”</button>
  <button id="btnMaximize" class="mini-maximize btn btn-neutral btn-sm" title="Restore" style="display:none;">â¤¢</button>
  <button id="btnCloseMini" class="mini-close btn btn-danger btn-sm" title="Close">âœ–</button>

  <audio id="miniAudio"></audio>
</div>

<footer class="site-footer">
  <p>&copy; {% now "Y" %} Islamic Web</p>
</footer>

<script>
/* -------------------------------------------
   Mobile menu
-------------------------------------------- */
document.addEventListener('DOMContentLoaded', function() {
  const toggle = document.getElementById('mobileMenuToggle');
  const menu = document.getElementById('mobileMenu');
  const close = document.getElementById('mobileMenuClose');

  function openMenu() {
    menu.classList.add('active');
    menu.setAttribute('aria-hidden', 'false');
    document.body.classList.add('no-scroll');
  }

  function closeMenu() {
    menu.classList.remove('active');
    menu.setAttribute('aria-hidden', 'true');
    document.body.classList.remove('no-scroll');
  }

  if (toggle && menu) {
    toggle.addEventListener('click', openMenu);
    close.addEventListener('click', closeMenu);

    menu.addEventListener('click', function(e) {
      if (e.target === menu) closeMenu();
    });

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') closeMenu();
    });
  }
});

/* -------------------------------------------
   Account dropdown (click + outside + ESC)
-------------------------------------------- */
(function(){
  function closeAll() {
    document.querySelectorAll('[data-dd]').forEach(el => {
      el.classList.remove('open');
      const btn = el.querySelector('[data-dd-btn]');
      if (btn) btn.setAttribute('aria-expanded', 'false');
    });
  }

  document.addEventListener('click', function(e) {
    const dd = e.target.closest('[data-dd]');
    const isBtn = e.target.closest('[data-dd-btn]');

    if (!dd) { closeAll(); return; }
    if (!isBtn) return;

    document.querySelectorAll('[data-dd]').forEach(el => {
      if (el !== dd) {
        el.classList.remove('open');
        const btn = el.querySelector('[data-dd-btn]');
        if (btn) btn.setAttribute('aria-expanded', 'false');
      }
    });

    dd.classList.toggle('open');
    const btn = dd.querySelector('[data-dd-btn]');
    if (btn) btn.setAttribute('aria-expanded', dd.classList.contains('open') ? 'true' : 'false');
  });

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeAll();
  });
})();
</script>

<!-- âœ… MINI PLAYER JS + âœ… RECORD PLAYHISTORY -->
<script>
/* ===========================
   MINI PLAYER (SIMPLE MODE)
   âœ… Play One
   âœ… Play All (auto next)
   âœ… Speed
   âœ… Minimize/Maximize/Close
   âœ… Record PlayHistory (if logged in)
=========================== */

const miniPlayer  = document.getElementById("miniPlayer");
const miniAudio   = document.getElementById("miniAudio");
const miniTitle   = document.getElementById("miniTitle");

const btnPlay     = document.getElementById("btnPlayPause");
const speedSelect = document.getElementById("speedSelect");
const btnClose    = document.getElementById("btnCloseMini");
const btnMinimize = document.getElementById("btnMinimize");
const btnMaximize = document.getElementById("btnMaximize");

const btnPrev     = document.getElementById("btnPrev");
const btnNext     = document.getElementById("btnNext");
const btnShuffle  = document.getElementById("btnShuffle");
const btnRepeat   = document.getElementById("btnRepeat");

const IS_AUTH = {% if user.is_authenticated %}true{% else %}false{% endif %};
const RECORD_URL = "{% url 'record_play' %}";

let playAllList = [];
let playAllIndex = 0;

/* CSRF from cookie */
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
  return "";
}

function recordPlay(recitationId) {
  if (!IS_AUTH) return;
  if (!recitationId) return;

  fetch(RECORD_URL, {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded",
      "X-CSRFToken": getCookie("csrftoken"),
    },
    body: "recitation_id=" + encodeURIComponent(recitationId)
  }).catch(() => {});
}

function showPlayer() { miniPlayer.style.display = "flex"; }

function setUIPlaying() {
  if (!btnPlay) return;
  btnPlay.textContent = miniAudio.paused ? "â–¶" : "â¸";
}

function setSpeed(val) {
  const speed = parseFloat(val) || 1;
  miniAudio.playbackRate = speed;
  if (speedSelect) speedSelect.value = String(speed);
}

function stopAll() { playAllList = []; playAllIndex = 0; }

/* âœ… plays + records */
function playAudio(src, title, recitationId=null) {
  if (!src) return;
  miniAudio.src = src;
  miniTitle.textContent = title || "â€”";
  showPlayer();

  recordPlay(recitationId);

  miniAudio.play().catch(() => {});
  setUIPlaying();
}

/* speed */
if (speedSelect) {
  speedSelect.addEventListener("change", (e) => {
    e.stopPropagation();
    setSpeed(speedSelect.value);
  });
}

/* play/pause */
if (btnPlay) {
  btnPlay.addEventListener("click", (e) => {
    e.stopPropagation();
    if (!miniAudio.src) return;
    if (miniAudio.paused) miniAudio.play().catch(() => {});
    else miniAudio.pause();
    setUIPlaying();
  });
}
miniAudio.addEventListener("play", setUIPlaying);
miniAudio.addEventListener("pause", setUIPlaying);

/* âœ… Play One (requires data-recitation-id in templates) */
document.addEventListener("click", (e) => {
  const playOne = e.target.closest("[data-play-one]");
  if (!playOne) return;

  e.preventDefault();
  stopAll();

  const recId = playOne.getAttribute("data-recitation-id");
  playAudio(
    playOne.getAttribute("data-audio"),
    playOne.getAttribute("data-title"),
    recId
  );
});

/* âœ… Play All (queue should include id) */
document.addEventListener("click", (e) => {
  const playAll = e.target.closest("[data-play-all]");
  if (!playAll) return;

  e.preventDefault();

  const scriptId = playAll.getAttribute("data-queue-script");
  const el = document.getElementById(scriptId);
  if (!el) return;

  let list = [];
  try { list = JSON.parse(el.textContent || "[]"); }
  catch (err) { console.error("Invalid JSON in queue script:", scriptId, err); return; }

  list = list.filter(x => x && x.audio);
  if (!list.length) return;

  playAllList = list;
  playAllIndex = 0;

  const item = playAllList[0];
  playAudio(item.audio, item.title, item.id || null);
});

/* Auto next */
miniAudio.addEventListener("ended", () => {
  if (!playAllList.length) return;

  playAllIndex += 1;
  if (playAllIndex < playAllList.length) {
    const item = playAllList[playAllIndex];
    playAudio(item.audio, item.title, item.id || null);
  } else {
    stopAll();
  }
});

/* minimize / maximize */
function toggleMinimize() {
  const isMinimized = miniPlayer.classList.contains("minimized");
  if (isMinimized) {
    miniPlayer.classList.remove("minimized");
    if (btnMinimize) btnMinimize.style.display = "inline-block";
    if (btnMaximize) btnMaximize.style.display = "none";
  } else {
    miniPlayer.classList.add("minimized");
    if (btnMinimize) btnMinimize.style.display = "none";
    if (btnMaximize) btnMaximize.style.display = "inline-block";
  }
}

if (btnMinimize) btnMinimize.addEventListener("click", (e) => { e.stopPropagation(); toggleMinimize(); });
if (btnMaximize) btnMaximize.addEventListener("click", (e) => { e.stopPropagation(); toggleMinimize(); });

miniPlayer.addEventListener("click", (e) => {
  if (!miniPlayer.classList.contains("minimized")) return;
  if (e.target.closest("button") || e.target.closest("select")) return;
  toggleMinimize();
});

/* close */
if (btnClose) {
  btnClose.addEventListener("click", (e) => {
    e.stopPropagation();
    stopAll();
    miniAudio.pause();
    miniAudio.currentTime = 0;
    miniAudio.src = "";
    miniTitle.textContent = "â€”";
    miniPlayer.style.display = "none";
    miniPlayer.classList.remove("minimized");
    if (btnMinimize) btnMinimize.style.display = "inline-block";
    if (btnMaximize) btnMaximize.style.display = "none";
    setUIPlaying();
  });
}

/* disable unused buttons */
[btnPrev, btnNext, btnShuffle, btnRepeat].forEach(b => {
  if (!b) return;
  b.addEventListener("click", (e) => { e.stopPropagation(); });
});

window.addEventListener("load", () => {
  setSpeed(speedSelect ? speedSelect.value : "1");
  setUIPlaying();
});
</script>

{% block extra_js %}{% endblock %}
</body>
</html>
